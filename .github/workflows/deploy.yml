name: Deploy via SSH (Hostinger split app/public)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST:      ${{ secrets.SSH_HOST }}
      SSH_PORT:      ${{ secrets.SSH_PORT }}
      SSH_USER:      ${{ secrets.SSH_USER }}
      APP_PATH:      ${{ secrets.APP_PATH }}
      PUBLIC_PATH:   ${{ secrets.PUBLIC_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Build frontend (Vite) ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Node deps
        run: npm ci

      - name: Build assets (Vite)
        run: npm run build

      # ---- SSH prep (decode base64 key + known_hosts) ----
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT}" -t ed25519 "${SSH_HOST}" >> ~/.ssh/known_hosts

      # ---- Stage then tar (avoids "file changed as we read it") ----
      - name: Stage files
        run: |
          rm -rf _stage_app _stage_pub _app _pub
          mkdir -p _stage_app _stage_pub _app _pub

          # Copy the app (exclude heavy/runtime dirs)
          rsync -a . _stage_app \
            --exclude .git \
            --exclude node_modules \
            --exclude vendor \
            --exclude public/build \
            --exclude storage

          # Copy only built assets into public staging
          if [ -d public/build ]; then
            rsync -a public/build/ _stage_pub/build/
          fi

      - name: Create app bundle
        run: tar -C _stage_app -czf _app/app.tar.gz .

      - name: Create public bundle
        run: |
          if [ -d _stage_pub/build ]; then
            tar -C _stage_pub -czf _pub/public.tar.gz build
          else
            # make an empty tar so later steps don't fail
            tar -czf _pub/public.tar.gz --files-from /dev/null
          fi

      # ---- Upload to server home ----
      - name: Upload bundles to server
        run: |
          scp -P "${SSH_PORT}" _app/app.tar.gz _pub/public.tar.gz \
            "${SSH_USER}@${SSH_HOST}:~/"
          # optional: Hostinger front controller
          if [ -f index.hostinger.php ]; then
            scp -P "${SSH_PORT}" index.hostinger.php \
              "${SSH_USER}@${SSH_HOST}:~/index.hostinger.php"
          fi

      # ---- Remote deploy (composer + artisan + publish public/build) ----
      - name: Deploy on server
        run: |
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" \
            "APP_PATH='${APP_PATH}' PUBLIC_PATH='${PUBLIC_PATH}' bash -s" <<'EOSSH'
          set -e

          : "${APP_PATH:?APP_PATH not set}"
          : "${PUBLIC_PATH:?PUBLIC_PATH not set}"

          mkdir -p "$APP_PATH" "$PUBLIC_PATH" "$PUBLIC_PATH/build"

          # Extract uploads
          [ -f "$HOME/app.tar.gz" ]    && tar -xzf "$HOME/app.tar.gz" -C "$APP_PATH"    && rm -f "$HOME/app.tar.gz"
          [ -f "$HOME/public.tar.gz" ] && tar -xzf "$HOME/public.tar.gz" -C "$PUBLIC_PATH" && rm -f "$HOME/public.tar.gz"

          # Put public index in place if provided
          if [ -f "$HOME/index.hostinger.php" ]; then
            mv -f "$HOME/index.hostinger.php" "$PUBLIC_PATH/index.php"
          fi

          cd "$APP_PATH"

          # Composer (fallback to local PHAR if not installed)
          if command -v composer >/dev/null 2>&1; then
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction
          else
            php -r "copy('https://getcomposer.org/installer','composer-setup.php');"
            php composer-setup.php --filename=composer
            php composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction
          fi

          # Ensure .env exists (don't overwrite if present)
          if [ ! -f ".env" ]; then
            cp -f .env.example .env || true
          fi

          # Generate APP_KEY if empty
          if ! grep -q "^APP_KEY=" .env || [ -z "$(grep '^APP_KEY=' .env | cut -d= -f2)" ]; then
            php artisan key:generate --force || true
          fi

          # Best-effort framework tasks
          php artisan storage:link    || true
          php artisan migrate --force || true
          php artisan optimize:clear  || true
          php artisan optimize        || true
          EOSSH
